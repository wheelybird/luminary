#!/bin/bash
set -e

ssl_dir="/opt/ssl"
php_dir="/opt/ldap_user_manager"

env_file_replace() {
  for env_file in $(env|grep _FILE=); do
    read -a env <<< "$(echo "$env_file" | sed 's/\(.*\)_FILE=\(.*\)/\1 \2/')"
    if [ -s "${env[1]}" ]; then
      echo Setting "${env[0]}" from "${env[1]}"
      export "${env[0]}"="$(cat "${env[1]}")"
      else echo "${env[1]} does not exist or is empty. Leaving ${env[0]} unset"
    fi
  done
}

if [ ! "$SERVER_HOSTNAME" ]; then export SERVER_HOSTNAME="ldapusermanager.org"; fi
if [ ! "$SERVER_PATH" ]; then
  export SERVER_PATH="/";
  apache_alias=""
else
  apache_alias="Alias $SERVER_PATH $php_dir"
fi

#If LDAP_TLS_CACERT is set then write it out as a file
#and set up the LDAP client conf to use it.

if [ "$LDAP_TLS_CACERT" ]; then
  echo "$LDAP_TLS_CACERT" >/opt/ca.crt
  mkdir -p /etc/ldap  
  sed -i "s/TLS_CACERT.*/TLS_CACERT \/opt\/ca.crt/" /etc/ldap/ldap.conf
fi

if [ "${NO_HTTPS,,}" == "true" ]; then

  cat <<EoHTTPC >/etc/apache2/sites-enabled/lum.conf

<VirtualHost *:${SERVER_PORT:-80}>

 ServerName $SERVER_HOSTNAME
 DocumentRoot $php_dir
 $apache_alias
 DirectoryIndex index.php index.html

 <Directory $php_dir>
   Require all granted
 </Directory>

</VirtualHost>
EoHTTPC


  echo "Listen ${SERVER_PORT:-80}" > /etc/apache2/ports.conf

else

  ########################
  #If there aren't any SSL certs then create a CA and then CA-signed certificate

  if [ ! -f "${ssl_dir}/${SERVER_CERT_FILENAME:-server.crt}" ] && [ ! -f "${ssl_dir}/${SERVER_KEY_FILENAME:-server.key}" ]; then

    mkdir -p $ssl_dir
    confout="${ssl_dir}/conf"
    keyout="${ssl_dir}/server.key"
    certout="${ssl_dir}/server.crt"
    cakey="${ssl_dir}/.ca.key"
    cacert="${ssl_dir}/.ca.crt"
    serialfile="${ssl_dir}/.serial"

    echo "Generating CA key"
    openssl genrsa -out $cakey 2048
    if [ $? -ne 0 ]; then exit 1 ; fi

    echo "Generating CA certificate"
    openssl req \
            -x509 \
            -new \
            -nodes \
            -subj "/C=GB/ST=GB/L=GB/O=CA/OU=CA/CN=Wheelybird" \
            -key $cakey \
            -sha256 \
            -days 7300 \
            -out $cacert
    if [ $? -ne 0 ]; then exit 1 ; fi

    echo "Generating openssl configuration"

    cat <<EoCertConf >$confout
subjectAltName = DNS:${SERVER_HOSTNAME},IP:127.0.0.1
extendedKeyUsage = serverAuth
EoCertConf

    echo "Generating server key..."
    openssl genrsa -out $keyout 2048
    if [ $? -ne 0 ]; then exit 1 ; fi

    echo "Generating server signing request..."
    openssl req \
                 -subj "/CN=${SERVER_HOSTNAME}" \
                 -sha256 \
                 -new \
                 -key $keyout \
                 -out /tmp/server.csr
    if [ $? -ne 0 ]; then exit 1 ; fi

    echo "Generating server cert..."
    openssl x509 \
                  -req \
                  -days 7300 \
                  -sha256 \
                  -in /tmp/server.csr \
                  -CA $cacert \
                  -CAkey $cakey \
                  -CAcreateserial \
                  -CAserial $serialfile \
                  -out $certout \
                  -extfile $confout
    if [ $? -ne 0 ]; then exit 1 ; fi

  fi


  ########################
  #Create Apache config

  if [ -f "${ssl_dir}/${CA_CERT_FILENAME}" ]; then ssl_chain="SSLCertificateChainFile ${ssl_dir}/${CA_CERT_FILENAME}"; fi

  echo  > /etc/apache2/sites-enabled/lum.conf
  echo  > /etc/apache2/ports.conf

  if [ ! "$SERVER_PORT" ]; then

    echo "Listen 80" > /etc/apache2/ports.conf

    cat <<EoHTTPrd >/etc/apache2/sites-enabled/lum.conf

<VirtualHost *:80>

 RewriteEngine On
 RewriteRule ^/?(.*) https://%{SERVER_NAME}/\$1 [R,L]

</VirtualHost>

EoHTTPrd

  fi

  echo "Listen ${SERVER_PORT:-443}" >> /etc/apache2/ports.conf
  
  cat <<EoHTTPSC >>/etc/apache2/sites-enabled/lum.conf

<VirtualHost _default_:${SERVER_PORT:-443}>

 ServerName $SERVER_HOSTNAME

 DocumentRoot $php_dir
 $apache_alias
 DirectoryIndex index.php index.html

 <Directory $php_dir>
   Require all granted
 </Directory>

 SSLEngine On
 SSLCertificateFile ${ssl_dir}/${SERVER_CERT_FILENAME:-server.crt}
 SSLCertificateKeyFile ${ssl_dir}/${SERVER_KEY_FILENAME:-server.key}
 $ssl_chain

</VirtualHost>
EoHTTPSC

fi

########################
#If <env_var>_FILE is set, read and export env_var from the referenced file's contents
env_file_replace

########################
#Check TOTP schema if MFA is enabled

check_totp_schema() {
  # Only check if MFA is enabled
  if [ "${MFA_ENABLED,,}" != "true" ]; then
    export MFA_SCHEMA_OK="true"
    return 0
  fi

  echo "Checking TOTP schema availability..."

  # Check if we have required LDAP connection details
  if [ -z "$LDAP_URI" ] || [ -z "$LDAP_BASE_DN" ] || [ -z "$LDAP_ADMIN_BIND_DN" ] || [ -z "$LDAP_ADMIN_BIND_PWD" ]; then
    echo "WARNING: LDAP connection details not fully configured, cannot verify TOTP schema" >&2
    export MFA_SCHEMA_OK="false"
    return 0
  fi

  # Get configured object class and attribute names (or use defaults)
  totp_objectclass="${TOTP_OBJECTCLASS:-totpUser}"
  totp_secret_attr="${TOTP_SECRET_ATTRIBUTE:-totpSecret}"
  totp_status_attr="${TOTP_STATUS_ATTRIBUTE:-totpStatus}"
  totp_enrolled_attr="${TOTP_ENROLLED_DATE_ATTRIBUTE:-totpEnrolledDate}"
  totp_scratch_attr="${TOTP_SCRATCH_CODES_ATTRIBUTE:-totpScratchCode}"

  # Query LDAP schema for TOTP object class
  # Check cn=schema,cn=config (OpenLDAP) or cn=subschema (RFC 4512 standard location)
  schema_check=$(ldapsearch -x -H "$LDAP_URI" \
    -D "$LDAP_ADMIN_BIND_DN" \
    -w "$LDAP_ADMIN_BIND_PWD" \
    -b "cn=schema,cn=config" \
    -LLL \
    "(objectClass=olcSchemaConfig)" \
    olcObjectClasses 2>/dev/null | grep -i "$totp_objectclass" || true)

  # If not found in cn=schema,cn=config, try cn=subschema
  if [ -z "$schema_check" ]; then
    schema_check=$(ldapsearch -x -H "$LDAP_URI" \
      -D "$LDAP_ADMIN_BIND_DN" \
      -w "$LDAP_ADMIN_BIND_PWD" \
      -b "cn=subschema" \
      -s base \
      -LLL \
      objectClasses 2>/dev/null | grep -i "$totp_objectclass" || true)
  fi

  # Check if objectClass exists
  if [ -z "$schema_check" ]; then
    echo "WARNING: MFA is enabled but TOTP schema not found in LDAP" >&2
    echo "         Object class '$totp_objectclass' not found in schema" >&2
    echo "         MFA functionality will be disabled until schema is installed" >&2
    echo "         See https://github.com/wheelybird/ldap-totp-schema for installation" >&2
    export MFA_SCHEMA_OK="false"
  else
    # ObjectClass found, now check for required attributes
    echo "TOTP object class found: $totp_objectclass"

    missing_attrs=""
    for attr in "$totp_secret_attr" "$totp_status_attr" "$totp_enrolled_attr" "$totp_scratch_attr"; do
      attr_check=$(ldapsearch -x -H "$LDAP_URI" \
        -D "$LDAP_ADMIN_BIND_DN" \
        -w "$LDAP_ADMIN_BIND_PWD" \
        -b "cn=schema,cn=config" \
        -LLL \
        "(objectClass=olcSchemaConfig)" \
        olcAttributeTypes 2>/dev/null | grep -i "NAME '$attr'" || \
        ldapsearch -x -H "$LDAP_URI" \
        -D "$LDAP_ADMIN_BIND_DN" \
        -w "$LDAP_ADMIN_BIND_PWD" \
        -b "cn=subschema" \
        -s base \
        -LLL \
        attributeTypes 2>/dev/null | grep -i "NAME '$attr'" || true)

      if [ -z "$attr_check" ]; then
        missing_attrs="$missing_attrs $attr"
      fi
    done

    if [ -n "$missing_attrs" ]; then
      echo "WARNING: TOTP object class found but required attributes missing:$missing_attrs" >&2
      echo "         MFA functionality will be disabled until all attributes are installed" >&2
      export MFA_SCHEMA_OK="false"
    else
      echo "TOTP schema fully configured: all required attributes found"
      export MFA_SCHEMA_OK="true"
    fi
  fi

  # Always return 0 to prevent container restart loop
  return 0
}

check_totp_schema

########################
#Run Apache

# first arg is `-f` or `--some-option`
if [ "${1#-}" != "$1" ]; then
        set -- apache2-foreground "$@"
fi

exec "$@"
